{{/* Unified Repository View: Handles Directory Listing, File Viewing, and Empty Repo Setup */}}
{{template "base/header.tmpl" .}}
{{template "base/navbar.tmpl" .}}

{{if .IsFile}}
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" id="prism-light" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" id="prism-dark" disabled />
{{end}}

<style>
    .breadcrumb-item + .breadcrumb-item::before { 
        content: "/"; 
        color: var(--bs-secondary-color);
    }
    .list-group-item-action:hover {
        background-color: var(--bs-body-tertiary-bg);
        color: var(--bs-primary);
    }
    .breadcrumb-container {
        background-color: var(--bs-body-tertiary-bg);
        border: 1px solid var(--bs-border-color);
    }
    .setup-code {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
    }
    .code-container {
        border-radius: 8px;
        overflow: hidden;
        border: 1px solid var(--bs-border-color);
    }
    pre {
        margin-bottom: 0 !important;
        border-radius: 0 !important;
        background-color: var(--bs-body-tertiary-bg) !important;
    }
    code {
        font-family: 'Fira Code', 'Consolas', monospace;
        font-size: 0.9rem;
    }
</style>

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb py-2 px-3 breadcrumb-container rounded shadow-sm mb-0">
                <li class="breadcrumb-item">
                    <a href="/view/{{$.Owner}}/{{$.RepoName}}/{{$.CurrentBranch}}/" class="fw-bold text-decoration-none text-primary">
                        {{$.RepoName}}
                    </a>
                </li>
                {{range .Breadcrumbs}}
                <li class="breadcrumb-item"><a href="{{.Path}}" class="text-decoration-none text-body">{{.Name}}</a></li>
                {{end}}
            </ol>
        </nav>

        <div class="d-flex gap-2 align-items-center">
            <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle fw-bold" type="button" data-bs-toggle="dropdown">
                    Branch: {{.CurrentBranch}}
                </button>
                <ul class="dropdown-menu">
                    {{range .Branches}}
                    <li><a class="dropdown-item" href="/view/{{$.Owner}}/{{$.RepoName}}/{{.}}/">{{.}}</a></li>
                    {{end}}
                </ul>
            </div>
            <a href="/download/{{.Owner}}/{{.RepoName}}/{{.CurrentBranch}}" class="btn btn-sm btn-primary px-3 shadow-sm">
                <strong>‚Üì</strong> Download ZIP
            </a>
        </div>
    </div>

    {{if .IsFile}}
        <div class="card shadow-sm code-container">
            <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center border-bottom">
                <span class="font-monospace fw-bold">{{.FileName}}</span>
                <div class="btn-group">
                    <button class="btn btn-sm btn-outline-primary" onclick="copyToClipboard()">Copy</button>
                    <a href="?raw=true" class="btn btn-sm btn-outline-primary">Raw</a>
                </div>
            </div>
            <div class="card-body p-0">
                <pre class="line-numbers"><code class="language-{{if .Extension}}{{.Extension}}{{else}}clike{{end}}">{{.Content}}</code></pre>
            </div>
        </div>

    {{else if .Files}}
        <div class="card shadow-sm border mb-4">
            <div class="card-header bg-body-tertiary d-flex justify-content-between align-items-center py-2">
                <span class="small text-body-secondary">Last commit: <strong class="text-body">{{.LastCommit}}</strong></span>
            </div>
            <div class="list-group list-group-flush">
                {{range .Files}}
                <a href="{{.Name}}" class="list-group-item list-group-item-action d-flex align-items-center">
                    <span class="me-3">{{if .IsURL}}üìÅ{{else}}üìÑ{{end}}</span>
                    <span class="flex-grow-1">{{.Name}}</span>
                    {{if not .IsURL}}<span class="badge rounded-pill bg-light text-dark border small">{{.Size}} bytes</span>{{end}}
                </a>
                {{end}}
            </div>
        </div>

    {{else}}
        <div class="row">
            <div class="col-12">
                <div class="mb-4">
                    <h3 class="fw-bold text-body">Quick setup</h3>
                    <p class="text-body-secondary">Push an existing repository or create a new one from the command line.</p>
                </div>

                <div class="card shadow-sm border mb-4">
                    <div class="card-header bg-body-tertiary py-3">
                        <h5 class="mb-0 fw-semibold text-primary">Create a new repository</h5>
                    </div>
                    <div class="card-body setup-code p-0">
                        <pre class="p-3 mb-0"><code>echo "# {{.RepoName}}" >> README.md
git init
git add README.md
git commit -m "first commit"
git branch -M main
git remote add origin ssh://git@{{.SSHAddr}}/{{.Owner}}/{{.RepoName}}.git
git push -u origin main</code></pre>
                    </div>
                </div>

                <div class="card shadow-sm border">
                    <div class="card-header bg-body-tertiary py-3">
                        <h5 class="mb-0 fw-semibold text-primary">Push an existing repository</h5>
                    </div>
                    <div class="card-body setup-code p-0">
                        <pre class="p-3 mb-0"><code>git remote add origin ssh://git@{{.SSHAddr}}/{{.Owner}}/{{.RepoName}}.git
git branch -M main
git push -u origin main</code></pre>
                    </div>
                </div>
            </div>
        </div>
    {{end}}
</div>

{{if .IsFile}}
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/plugins/autoloader/prism-autoloader.min.js"></script>
<script>
    const updatePrismTheme = () => {
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        document.getElementById('prism-dark').disabled = !isDark;
        document.getElementById('prism-light').disabled = isDark;
    };

    const observer = new MutationObserver(updatePrismTheme);
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-bs-theme'] });
    updatePrismTheme();

    function copyToClipboard() {
        const code = document.querySelector('code').innerText;
        navigator.clipboard.writeText(code).then(() => {
            alert("Copied to clipboard!");
        });
    }
</script>
{{end}}

{{template "base/footer.tmpl" .}}