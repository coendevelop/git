{{/* Repository view template: shows file listing, branches, download and
   quick setup instructions for empty repos. Expects fields like .Owner,
   .RepoName, .Files, .Branches, .CurrentBranch and .LastCommit. */}}
{{template "base/header.tmpl" .}}
{{template "base/navbar.tmpl" .}}

<style>
    .breadcrumb-item + .breadcrumb-item::before { 
        content: "/"; 
        color: var(--bs-secondary-color);
    }
    .list-group-item-action:hover {
        background-color: var(--bs-body-tertiary-bg);
        color: var(--bs-primary);
    }
    .breadcrumb-container {
        background-color: var(--bs-body-tertiary-bg);
        border: 1px solid var(--bs-border-color);
    }
    /* Minimalist code block for setup instructions */
    .setup-code {
        background-color: var(--bs-tertiary-bg);
        border: 1px solid var(--bs-border-color);
        color: var(--bs-body-color);
    }
</style>

<div class="container py-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb py-2 px-3 breadcrumb-container rounded shadow-sm">
            <li class="breadcrumb-item">
                <a href="/view/{{$.Owner}}/{{$.RepoName}}/{{$.CurrentBranch}}/" class="fw-bold text-decoration-none text-primary">
                    {{$.RepoName}}
                </a>
            </li>
            {{range .Breadcrumbs}}
            <li class="breadcrumb-item">
                <a href="/view/{{$.Owner}}/{{$.RepoName}}/{{$.CurrentBranch}}/{{.Path}}" class="text-decoration-none">
                    {{.Name}}
                </a>
            </li>
            {{end}}
        </ol>
    </nav>

    <div class="d-flex align-items-center mb-4">
        <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3 shadow-sm" style="width: 48px; height: 48px;">
            üìÑ
        </div>
        <div class="flex-grow-1">
            <h2 class="mb-0 text-body">
                <span class="text-body-secondary fw-light">{{.Owner}} /</span> {{.RepoName}}
            </h2>
            {{if .LastCommit}}
                <p class="text-body-secondary small mb-0">
                    Latest commit: <span class="font-monospace text-primary">{{printf "%.7s" .LastCommit.Hash}}</span> 
                    ‚Äî {{.LastCommit.Message}}
                </p>
            {{else}}
                <p class="text-warning small mb-0">No commits yet</p>
            {{end}}
        </div>

        {{if .Files}}
        <div class="d-flex gap-2">
            <div class="dropdown">
                <button class="btn btn-outline-primary dropdown-toggle btn-sm shadow-sm" type="button" data-bs-toggle="dropdown">
                    <span class="text-body-secondary small">Branch:</span> <strong>{{$.CurrentBranch}}</strong>
                </button>
                <ul class="dropdown-menu dropdown-menu-end shadow">
                    {{range .Branches}}
                    <li><a class="dropdown-item {{if eq . $.CurrentBranch}}active{{end}}" href="/view/{{$.Owner}}/{{$.RepoName}}/{{.}}/">{{.}}</a></li>
                    {{end}}
                </ul>
            </div>
            <div class="d-flex align-items-center gap-2">
                <button class="btn btn-sm btn-primary star-btn shadow-sm fw-bold px-2 rounded-pill d-inline-flex align-items-center gap-1" data-owner="{{.Owner}}" data-repo="{{.RepoName}}" aria-label="Toggle favorite" aria-pressed="{{if .IsFavorite}}true{{else}}false{{end}}">
                    <span class="star-glyph fs-5">{{if .IsFavorite}}‚òÖ{{else}}‚òÜ{{end}}</span>
                    <span class="small ms-1 star-count">{{.StarCount}}</span>
                </button>
                <a href="/download/view/{{$.Owner}}/{{$.RepoName}}/{{$.CurrentBranch}}" class="btn btn-sm btn-primary shadow-sm fw-bold px-2 rounded-pill d-inline-flex align-items-center gap-1" role="button" aria-label="Download {{$.RepoName}} as zip" title="{{.DownloadCount}} downloads">
                    <span class="d-inline-block fs-5">üì¶</span>
                    <span class="small ms-1 d-none d-sm-inline">{{.DownloadCount}}</span>
                </a>
            </div>
        </div>
        {{end}}
    </div>

    {{if .Files}}
    <div class="card shadow-sm border">
        <div class="card-header bg-body-tertiary py-3 d-flex justify-content-between align-items-center border-bottom">
            <span class="fw-bold text-body">Files</span>
            <span class="badge bg-secondary-soft text-secondary border border-secondary px-3 rounded-pill">
                {{len .Files}} items
            </span>
        </div>
        <div class="list-group list-group-flush">
            {{if $.CurrentPath}}
                <a href=".." class="list-group-item list-group-item-action py-2 text-primary bg-body">
                    üìÅ .. <span class="text-body-secondary italic small">(Go back)</span>
                </a>
            {{end}}
            {{range .Files}}
            <a href="/view/{{$.Owner}}/{{$.RepoName}}/{{$.CurrentBranch}}/{{if $.CurrentPath}}{{$.CurrentPath}}/{{end}}{{.Name}}" 
                class="list-group-item list-group-item-action d-flex align-items-center py-3 bg-body">
                <span class="me-3 fs-5">{{if .Mode.IsFile}} üìÑ {{else}} üìÅ {{end}}</span>
                <span class="flex-grow-1 text-body">{{.Name}}</span>
                <span class="text-body-secondary small d-none d-md-inline">View details</span>
            </a>
            {{end}}
        </div>
    </div>

    {{else}}
    <div class="row">
        <div class="col-12">
            <div class="mb-4">
                <h3 class="fw-bold text-body">Quick setup</h3>
                <p class="text-body-secondary">Push an existing repository or create a new one from the command line.</p>
            </div>

            <div class="card shadow-sm border mb-4">
                <div class="card-header bg-body-tertiary py-3">
                    <h5 class="mb-0 fw-semibold text-primary">Create a new repository</h5>
                </div>
                <div class="card-body setup-code p-0">
                    <pre class="p-3 mb-0"><code>echo "# {{.RepoName}}" >> README.md
git init
git add README.md
git commit -m "first commit"
git branch -M main
git remote add origin ssh://git@{{.SSHAddr}}/{{.Owner}}/{{.RepoName}}.git
git push -u origin main</code></pre>
                </div>
            </div>

            <div class="card shadow-sm border">
                <div class="card-header bg-body-tertiary py-3">
                    <h5 class="mb-0 fw-semibold text-primary">Push an existing repository</h5>
                </div>
                <div class="card-body setup-code p-0">
                    <pre class="p-3 mb-0"><code>git remote add origin ssh://git@{{.SSHAddr}}/{{.Owner}}/{{.RepoName}}.git
git branch -M main
git push -u origin main</code></pre>
                </div>
            </div>
        </div>
    </div>
    {{end}}
</div>

{{template "base/footer.tmpl" .}}